#!/usr/bin/env bash
set -euo pipefail

# ==============================================================================
# 04-portal-api.sh  OpenKPI Portal API (Phase 1)  DROP-IN / REPEATABLE
#
# Key rule: DO NOT use variable name "HERE". 00-env.sh overwrites it.
# This script uses MOD_DIR for its own location and never depends on CWD.
#
# Contract:
# - Packages ./app -> app.tgz
# - Publishes ConfigMap ${PLATFORM_NS}/portal-api-src (key: app.tgz)
# - Deployment:
#     initContainer: untar to /work
#     container: python:3.12-slim installs requirements then runs gunicorn on :8000
# - Service: portal-api:${PORTAL_API_PORT}
# - NO Ingress here (UI module owns shared host routing /api)
# ==============================================================================

MOD_DIR="$(cd -- "$(dirname -- "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
ROOT="$(cd -- "${MOD_DIR}/../../.." && pwd)"

# shellcheck source=/dev/null
. "${ROOT}/00-env.sh"
# shellcheck source=/dev/null
. "${ROOT}/00-lib.sh"

require_cmd kubectl tar

: "${PLATFORM_NS:=platform}"
: "${PORTAL_API_DEPLOY:=portal-api}"
: "${PORTAL_API_SVC:=portal-api}"
: "${PORTAL_API_PORT:=8000}"

log "[04][portal-api] start (ns=${PLATFORM_NS}, mod_dir=${MOD_DIR})"

kubectl get ns "${PLATFORM_NS}" >/dev/null 2>&1 || kubectl create ns "${PLATFORM_NS}" >/dev/null

# ---- app assets (module-local)
APP_DIR="${MOD_DIR}/app"
if [[ ! -d "${APP_DIR}" ]]; then
  echo "FATAL: missing ${APP_DIR}"
  ls -la "${MOD_DIR}"
  exit 1
fi
if [[ ! -f "${APP_DIR}/requirements.txt" ]]; then
  echo "FATAL: missing ${APP_DIR}/requirements.txt"
  ls -la "${APP_DIR}"
  exit 1
fi

# ---- package app/ -> app.tgz (must contain top-level folder app/)
TMP="$(mktemp -d)"
trap 'rm -rf "${TMP}"' EXIT
tar -czf "${TMP}/app.tgz" -C "${MOD_DIR}" app

# ---- ConfigMap (idempotent)
kubectl -n "${PLATFORM_NS}" create configmap portal-api-src \
  --from-file=app.tgz="${TMP}/app.tgz" \
  -o yaml --dry-run=client | kubectl apply -f - >/dev/null

# ---- Deployment + Service (idempotent apply)
kubectl apply -f - <<YAML
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${PORTAL_API_DEPLOY}
  namespace: ${PLATFORM_NS}
  labels: { app: portal-api }
spec:
  replicas: 1
  selector:
    matchLabels: { app: portal-api }
  template:
    metadata:
      labels: { app: portal-api }
    spec:
      volumes:
        - name: api-src
          configMap:
            name: portal-api-src
        - name: api-work
          emptyDir: {}
      initContainers:
        - name: unpack
          image: alpine:3.20
          command: ["sh","-lc","set -e; mkdir -p /work; tar -xzf /src/app.tgz -C /work; test -f /work/app/requirements.txt; ls -la /work/app | head -n 30"]
          volumeMounts:
            - name: api-src
              mountPath: /src
              readOnly: true
            - name: api-work
              mountPath: /work
      containers:
        - name: api
          image: python:3.12-slim
          env:
            - name: PORT
              value: "${PORTAL_API_PORT}"
            - name: OPENKPI_NS
              value: "${OPENKPI_NS:-open-kpi}"
            - name: PLATFORM_NS
              value: "${PLATFORM_NS}"
            - name: AIRBYTE_NS
              value: "${AIRBYTE_NS:-airbyte}"
            - name: ANALYTICS_NS
              value: "${ANALYTICS_NS:-analytics}"
            - name: N8N_NS
              value: "${N8N_NS:-n8n}"
            - name: TICKETS_NS
              value: "${TICKETS_NS:-tickets}"
            - name: TRANSFORM_NS
              value: "${TRANSFORM_NS:-transform}"

            # Optional service hosts (your app can ignore if unused)
            - name: POSTGRES_HOST
              value: "${OPENKPI_PG_HOST:-${POSTGRES_SERVICE:-openkpi-postgres.open-kpi.svc.cluster.local}}"
            - name: POSTGRES_PORT
              value: "${OPENKPI_PG_PORT:-${POSTGRES_PORT:-5432}}"
            - name: POSTGRES_DB
              value: "${OPENKPI_PG_DB:-${POSTGRES_DB:-openkpi}}"
            - name: POSTGRES_USER
              value: "${OPENKPI_PG_USER:-${POSTGRES_USER:-openkpi_admin}}"
            - name: POSTGRES_PASSWORD
              value: "${OPENKPI_PG_PASSWORD:-${POSTGRES_PASSWORD:-}}"

            - name: MINIO_ENDPOINT
              value: "${MINIO_ENDPOINT_INTERNAL:-${OPENKPI_MINIO_ENDPOINT:-http://openkpi-minio.open-kpi.svc.cluster.local:9000}}"
            - name: MINIO_USER
              value: "${MINIO_ROOT_USER:-${OPENKPI_MINIO_USER:-}}"
            - name: MINIO_PASSWORD
              value: "${MINIO_ROOT_PASSWORD:-${OPENKPI_MINIO_PASSWORD:-}}"
          workingDir: /work
          command: ["sh","-lc"]
          args:
            - |
              set -e
              python -m pip install --no-cache-dir -r /work/app/requirements.txt >/dev/null
              exec python -m gunicorn -b 0.0.0.0:${PORT} "app.server:app" --workers 2 --threads 4 --timeout 60
          ports:
            - containerPort: ${PORTAL_API_PORT}
          readinessProbe:
            httpGet: { path: /api/health, port: ${PORTAL_API_PORT} }
            initialDelaySeconds: 3
            periodSeconds: 10
          livenessProbe:
            httpGet: { path: /api/health, port: ${PORTAL_API_PORT} }
            initialDelaySeconds: 10
            periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: ${PORTAL_API_SVC}
  namespace: ${PLATFORM_NS}
  labels: { app: portal-api }
spec:
  selector: { app: portal-api }
  ports:
    - name: http
      port: ${PORTAL_API_PORT}
      targetPort: ${PORTAL_API_PORT}
YAML

kubectl -n "${PLATFORM_NS}" rollout status "deploy/${PORTAL_API_DEPLOY}" --timeout=180s
log "[04][portal-api] OK"
